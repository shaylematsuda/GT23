---
title: "Metadata"
author: "matsuda"
date: "2023-05-12"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(dplyr)
library(openxlsx)

```

## R Markdown
```{r}

bag.loc<-read.csv("metadata for bags.csv") #cols: fragid and tank location
bag.loc$fragid<-as.factor(bag.loc$fragid)
bag.loc$tank<-as.factor(bag.loc$tank) 

#correct issues
bag.loc <- bag.loc %>%
  mutate(fragid = case_when(
    fragid == "1273-11" & tank == "HI_Control_1"     ~ "1273-4",
    fragid == "1291-2"  & tank == "President's"      ~ "1291-5",
    TRUE ~ fragid
  ))

species<-read.csv("species_frag.csv") # cols: fragid and species
species$species<-as.factor(species$species)

meta<-merge(bag.loc, species, by="fragid",all.x= TRUE)

meta <- rename(meta, Frag.ID = fragid)

#write.csv(meta,"metadataGT23.csv")
```
Join meta with tissue sample data
```{r}
samp_meta<-read.csv("GT23_metadata_fromsharepoint_20250707.csv")
  samp_meta$Frag.ID<-as.factor(samp_meta$Frag.ID)
    samp_meta$Tank<-as.factor(samp_meta$Tank)
    samp_meta$Type<-as.factor(samp_meta$Type)

  samp_meta <- samp_meta %>%
  mutate(Frag.ID = case_when(
    Frag.ID == "1273-11" & Tank == "HI_Control_1" ~ "1273-4",
    TRUE ~ Frag.ID
  ))

  samp_meta <- samp_meta %>%
  rename(Tank.datasheet = Tank)
    
   merged_df<- left_join(samp_meta, meta, by = "Frag.ID")

   
  Frag.name.match<- merged_df %>%
  group_by(Frag.ID) %>%
  summarise(
    n = n(),
    Tube = paste(unique(Tube), collapse = ", ")
  ) %>%
  arrange(desc(n))

  # write.csv(Frag.name.match,"Frag.name.match.csv") figure out which frag ID recorded wrong and fix
  
merged_df <- merged_df %>%
  mutate(
    Frag.ID = case_when(
      Tube == 253 ~ "1293-1",
      Tube == 274 ~ "1283-4",
      Tube == 379 ~ "874-7",
      TRUE ~ Frag.ID
    )
  )
   
well_meta<-read.csv("GT23PCRPlateKey.csv")
well_meta <- rename(well_meta, DNAwell = Well)
well_meta <- well_meta %>%  #if duplicates write dup
  group_by(Tube) %>%
  mutate(dup = if_else(n() > 1, "dup", NA_character_)) %>%
  ungroup()
#write.csv(merged_dftest,"merged_dftest.csv")

merged_df <- left_join(merged_df, meta, by = "Frag.ID")

#add genotype
geno<-read.csv("genotype_frag.csv")
df_final<-merged_df #make copy so you dont. have to keep rerunning

df_final <- df_final %>%
  left_join(geno %>% select(Frag.ID, Geno),
            by = "Frag.ID")

extra<-subset(df_final, Tank.datasheet=="Extra") #look at extra frags and then label in final df

extra_ids <- unique(extra$Frag.ID)

df_final <- df_final %>%
  mutate(
    Extra = if_else(Frag.ID %in% extra_ids, "yes", "no")
  )

#next, identify if we need those ramets. 







#these include the antibiotics. they do not include sterivex

#create ACER subset: 
Acer<-subset(test, species=="Acer") #355 samples
Acer<-subset(Acer, Time.point!="Week 3") # Remove week 3, 306 samples
Acer<-subset(Acer, Tank.datasheet!="Extra") #remove extras, 295 samples
Acer<-subset(Acer, Notes!="Before moving to Quad") #remove extras, 287 samples

#create MCAP subset: 345 samples
Mcap<-subset(test, species=="Mcap") #345 samps
Mcap<-subset(Mcap, Time.point!="Week 3") # remove week 3 292 samples
Mcap<-subset(Mcap, Tank.datasheet!="Extra") #remove extras, 280 samples
Mcap<-subset(Mcap, Notes!="Before moving to Quad") #remove extras, 280 samples
Mcap<-subset(Mcap, Tube!="1455") #remove extras, 269 samples
Mcap <- subset(Mcap, !is.na(DNA_plateN))

#total 556 acer and mcap without week 3. and missing some day 0 which sucks this is the run

```

Let's make plates: 2 PCR blanks, 1 Mock, 1 DNA blank, try to keep Time.points together and species together
```{r}
library(dplyr)


# Step 1: Combine Acer and Mcap with a column to track species
Acer <- Acer %>% mutate(SpeciesGroup = "Acer")
Mcap <- Mcap %>% mutate(SpeciesGroup = "Mcap")

samples <- bind_rows(Acer, Mcap)

# Step 2: Sort to prioritize grouping by species, then Time.point
samples_ordered <- samples %>%
  arrange(SpeciesGroup, Time.point)

# Step 3: Assign samples to plates (92 per plate)
samples_ordered <- samples_ordered %>%
  mutate(qPCRplate_number = ceiling(row_number() / 92))

# Step 4: Create 4 controls per plate
control_set <- data.frame(
  species = c("PCR_blank", "PCR_blank", "Mock", "DNA_blank"),
  Frag.ID = NA,
  Time.point = NA,
  SpeciesGroup = "Control"
)

# Duplicate the control set for each plate
num_plates <- max(samples_ordered$qPCRplate_number)
plate_controls <- lapply(1:num_plates, function(p) {
  control_set %>%
    mutate(qPCRplate_number = p,
           Frag.ID = paste(species, p, sep = "_"))
}) %>%
  bind_rows()

# Step 5: Combine controls with samples
final_layout <- bind_rows(samples_ordered, plate_controls) %>%
  arrange(qPCRplate_number, SpeciesGroup, Time.point, Frag.ID)

# Step 6: Assign well positions A1–H12 (8 × 12 = 96 wells per plate)
rows <- LETTERS[1:8]
cols <- 1:12
wells <- expand.grid(Row = rows, Column = cols) %>%
  arrange(Row, Column) %>%
  mutate(Well = paste0(Row, Column)) %>%
  pull(Well)

# Assign well positions within each plate
final_layout <- final_layout %>%
  group_by(qPCRplate_number) %>%
  mutate(Well = wells[1:n()]) %>%
  ungroup()

# View output
final_layout %>% select(qPCRplate_number, Well, Frag.ID, species, Time.point, SpeciesGroup)

final_layout <- final_layout %>% #organize by plate and well
  group_by(qPCRplate_number) %>%
  arrange(DNA_plate, Well, .by_group = TRUE) %>%
  ungroup()




#make excel 96 well plate doc ####
#First, do this by Tube number 

# 1. Define well order
rows <- LETTERS[1:8]
cols <- sprintf("%02d", 1:12)
wells <- paste0(rep(rows, each = 12), cols)

# 2. Ensure your data has the 'Well' field in A01–H12 format
# If your Well column isn't already in that format, fix it:
final_layout <- final_layout %>%
  mutate(Well = toupper(Well))  # Ensure it's A01, A02, etc.

# 3. Create a workbook
wb <- createWorkbook()

# 4. Loop over each plate and format it as a plate layout
plates <- unique(final_layout$qPCRplate_number)

for (plate in plates) {
  
  plate_data <- final_layout %>% 
    filter(qPCRplate_number == plate) %>%
    mutate(Row = substr(Well, 1, 1),
           Column = as.integer(substr(Well, 2, 3))) %>%
    select(Row, Column, Frag.ID)  # Or change to `tube`, `species`, etc.

  # Create an 8x12 matrix with row names A-H and column names 1-12
  plate_matrix <- matrix(NA, nrow = 8, ncol = 12,
                         dimnames = list(LETTERS[1:8], 1:12))

  # Fill the matrix with Frag.ID or whatever value you want
  for (i in 1:nrow(plate_data)) {
    r <- plate_data$Row[i]
    c <- plate_data$Column[i]
    plate_matrix[r, c] <- plate_data$Frag.ID[i]
  }

  # Convert to data frame
  plate_df <- as.data.frame(plate_matrix)
  plate_df <- tibble::rownames_to_column(plate_df, var = "Row")

  # Add sheet to workbook
  addWorksheet(wb, paste0("Plate_", plate))
  writeData(wb, sheet = paste0("Plate_", plate), plate_df)
}

# 5. Save workbook
saveWorkbook(wb, "96_well_plate_layouts_byTUBE.xlsx", overwrite = TRUE)

##Next do this by DNA plate and DNA well location:

library(tidyverse)
library(openxlsx)

# 1. Define row/column structure for 96-well
rows <- LETTERS[1:8]
cols <- sprintf("%02d", 1:12)

# 2. Ensure Well is uppercase (e.g., A01)
final_layout <- final_layout %>%
  mutate(Well = toupper(Well))

# 3. Create workbook
wb <- createWorkbook()

# 4. Loop through each plate and populate matrix with DNA_plate + DNA_well
plates <- unique(final_layout$qPCRplate_number)

for (plate in plates) {
  
  plate_data <- final_layout %>% 
    filter(qPCRplate_number == plate) %>%
    mutate(
      Row = substr(Well, 1, 1),
      Column = as.integer(substr(Well, 2, 3)),
      Combined = paste0(DNA_plate, "_", Well)  # Combine DNA_plate and DNA_well ### Trista- this was the spot were the error was. it said "Well" which was the new well location, and not DNAwell.
    ) %>%
    select(Row, Column, Combined)

  # 5. Create blank 8x12 plate matrix
  plate_matrix <- matrix(NA, nrow = 8, ncol = 12,
                         dimnames = list(LETTERS[1:8], 1:12))

  # 6. Fill the matrix
  for (i in 1:nrow(plate_data)) {
    r <- plate_data$Row[i]
    c <- plate_data$Column[i]
    plate_matrix[r, c] <- plate_data$Combined[i]
  }

  # 7. Convert to data frame for Excel output
  plate_df <- as.data.frame(plate_matrix)
  plate_df <- tibble::rownames_to_column(plate_df, var = "Row")

  # 8. Add sheet and write data
  addWorksheet(wb, paste0("Plate_", plate))
  writeData(wb, sheet = paste0("Plate_", plate), plate_df)
}

# 9. Save Excel file
saveWorkbook(wb, "96_well_plate_DNA_layouts_Bad.xlsx", overwrite = TRUE)



```
New code below to order by plate once you
```{r}

library(tidyverse)
library(openxlsx)

# -----------------------
# Helpers
# -----------------------
normalize_well <- function(x) {
  x <- toupper(x)
  ifelse(nchar(x) == 2, paste0(substr(x, 1, 1), "0", substr(x, 2, 2)), x)
}
well_levels <- paste0(rep(LETTERS[1:8], each = 12), sprintf("%02d", 1:12))

# -----------------------
# Step 1: Combine Acer and Mcap with species tracker
# -----------------------
Acer <- Acer %>% mutate(SpeciesGroup = "Acer")
Mcap <- Mcap %>% mutate(SpeciesGroup = "Mcap")
samples <- bind_rows(Acer, Mcap)

# If your data sometimes uses DNA_well instead of DNAwell, coalesce here
if (!"DNAwell" %in% names(samples) && "DNA_well" %in% names(samples)) {
  samples <- samples %>% mutate(DNAwell = DNA_well)
}

# Normalize DNAwell to A01 format (important for matching)
if ("DNAwell" %in% names(samples)) {
  samples <- samples %>% mutate(DNAwell = normalize_well(DNAwell))
}

# -----------------------
# Step 2–3: Sort, assign qPCR plates, then order by DNA source within each plate
# -----------------------
samples_ordered <- samples %>%
  arrange(SpeciesGroup, Time.point) %>%
  mutate(qPCRplate_number = ceiling(row_number() / 92)) %>%
  group_by(qPCRplate_number) %>%
  {
    if ("DNAwell" %in% names(.)) {
      arrange(., DNA_plate, factor(DNAwell, levels = well_levels), .by_group = TRUE)
    } else {
      arrange(., DNA_plate, .by_group = TRUE)
    }
  } %>%
  ungroup()

# -----------------------
# Step 4: Controls (4 per plate)
# -----------------------
control_set <- tibble(
  species = c("PCR_blank", "PCR_blank", "Mock", "DNA_blank"),
  Tube = NA_character_,
  Frag.ID = NA_character_,
  Time.point = NA,
  SpeciesGroup = "Control",
  DNA_plate = NA_character_,
  DNAwell = NA_character_
)

num_plates <- max(samples_ordered$qPCRplate_number, na.rm = TRUE)
plate_controls <- map_dfr(1:num_plates, ~ control_set %>%
                            mutate(qPCRplate_number = .x,
                                   Frag.ID = paste(species, .x, sep = "_")))

# -----------------------
# Step 5: Combine and arrange
# -----------------------
final_layout <- bind_rows(samples_ordered, plate_controls) %>%
  arrange(qPCRplate_number,
          SpeciesGroup == "Control",  # samples first
          DNA_plate,
          Time.point,
          Frag.ID)

# -----------------------
# Step 6: Assign Well positions A01–H12 within each qPCR plate
# -----------------------
wells <- well_levels
final_layout <- final_layout %>%
  group_by(qPCRplate_number) %>%
  mutate(Well = wells[seq_len(n())]) %>%
  ungroup()

# Optional: view
# final_layout %>% select(qPCRplate_number, Well, Tube, Frag.ID, species, Time.point, SpeciesGroup, DNA_plate, DNAwell)

# ----------------------------
# Excel 1: by Tube (prints Tube)
# ----------------------------
wb1 <- createWorkbook()
plates <- sort(unique(final_layout$qPCRplate_number))

for (plate in plates) {
  plate_data <- final_layout %>% 
    filter(qPCRplate_number == plate) %>%
    mutate(Row = substr(Well, 1, 1),
           Column = as.integer(substr(Well, 2, 3))) %>%
    select(Row, Column, Tube)

  plate_matrix <- matrix(NA_character_, nrow = 8, ncol = 12,
                         dimnames = list(LETTERS[1:8], as.character(1:12)))

  for (i in seq_len(nrow(plate_data))) {
    r <- plate_data$Row[i]
    c <- plate_data$Column[i]
    plate_matrix[r, as.character(c)] <- plate_data$Tube[i]
  }

  plate_df <- as.data.frame(plate_matrix) %>%
    tibble::rownames_to_column(var = "Row")

  addWorksheet(wb1, paste0("Plate_", plate, "_byTUBE"))
  writeData(wb1, sheet = paste0("Plate_", plate, "_byTUBE"), plate_df)
}

saveWorkbook(wb1, "96_well_plate_layouts_byTUBE.xlsx", overwrite = TRUE)

# ---------------------------------------------
# Excel 2: by DNA plate + DNAwell (controls blank)
# ---------------------------------------------
wb2 <- createWorkbook()

for (plate in plates) {
  plate_data <- final_layout %>% 
    filter(qPCRplate_number == plate) %>%
    mutate(
      Row = substr(Well, 1, 1),
      Column = as.integer(substr(Well, 2, 3)),
      Combined = if_else(!is.na(DNA_plate) & !is.na(DNAwell),
                         paste0(DNA_plate, "_", DNAwell), "")
    ) %>%
    select(Row, Column, Combined)

  plate_matrix <- matrix(NA_character_, nrow = 8, ncol = 12,
                         dimnames = list(LETTERS[1:8], as.character(1:12)))

  for (i in seq_len(nrow(plate_data))) {
    r <- plate_data$Row[i]
    c <- plate_data$Column[i]
    plate_matrix[r, as.character(c)] <- plate_data$Combined[i]
  }

  plate_df <- as.data.frame(plate_matrix) %>%
    tibble::rownames_to_column(var = "Row")

  addWorksheet(wb2, paste0("Plate_", plate, "_byDNA"))
  writeData(wb2, sheet = paste0("Plate_", plate, "_byDNA"), plate_df)
}

saveWorkbook(wb2, "96_well_plate_DNA_layouts.xlsx", overwrite = TRUE)

# ---------------------------------------------
# Optional QC workbook (per-well crosscheck table)
# ---------------------------------------------
# wb3 <- createWorkbook()
# for (plate in plates) {
#   cross <- final_layout %>%
#     filter(qPCRplate_number == plate) %>%
#     transmute(
#       qPCRplate_number,
#       Well,
#       Tube,
#       Frag.ID,
#       DNA_plate,
#       DNAwell,
#       DNA_combo = if_else(!is.na(DNA_plate) & !is.na(DNAwell),
#                           paste0(DNA_plate, "_", DNAwell), "")
#     ) %>%
#     arrange(Well)
#   addWorksheet(wb3, paste0("Plate_", plate, "_crosscheck"))
#   writeData(wb3, paste0("Plate_", plate, "_crosscheck"), cross)
# }
# saveWorkbook(wb3, "qPCR_layout_crosscheck.xlsx", overwrite = TRUE)

```

MiSeq
```{r}
MiSeq<-read.csv("GT23 sample order.csv")

library(dplyr)

library(dplyr)

# Create a column in samples that matches the MiSeq Sample.name format
samples <- samples %>%
  mutate(Sample.name = paste(DNA_plate, DNAwell, sep = "_"))

library(dplyr)

# Make sure the matching key exists and is formatted correctly in samples
samples_key <- samples %>%
  mutate(Sample.name = paste(DNA_plate, DNAwell, sep = "_")) %>%
  select(Sample.name, Tube) %>%
  distinct()   # ensure no duplicates

# Join Tube info into MiSeq; unmatched rows stay with NA
MiSeq <- MiSeq %>%
  left_join(samples_key, by = "Sample.name")
write.csv(MiSeq, "MiSeq.csv")
```

Find samples for each genotype:
```{r}
df_final <- df_final %>%
  filter(!Tube %in% c(267, 227))

df_day0 <- df_final %>%
  filter(Time.point == "Day 0")


write.csv(df_day0, "df_day0.csv")

trinity<-read.csv("trinity.csv")

rows <- LETTERS[1:8]
cols <- 1:12

plate_layout <- expand.grid(Row = rows, Col = cols) %>%
  mutate(Well = paste0(Row, Col)) %>%
  arrange(Row, Col)

library(dplyr)
library(purrr)

df_list <- trinity %>%
  split(.$Frag.ID) %>%    # splits into a list per Frag.ID
  map(~ plate_layout %>%
        left_join(.x %>% select(DNA_plateN, DNAwell),
                  by = c("Well" = "DNAwell")))



iwalk(df_list, ~ write.csv(.x, paste0("plate_", .y, ".csv"), row.names = FALSE))

```


